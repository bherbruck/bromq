name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  # Backend testing with Go
  test-go:
    name: Go Tests
    runs-on: ubuntu-latest
    needs: test-frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download frontend build
        uses: actions/download-artifact@v5
        with:
          name: frontend-build
          path: web/dist/

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Display test coverage
        run: go tool cover -func=coverage.out

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: go-coverage
          path: coverage.out
          retention-days: 7

  # Database integration tests
  test-databases:
    name: Database Tests
    runs-on: ubuntu-latest
    needs: test-frontend
    strategy:
      matrix:
        database: [sqlite, postgres, mysql]

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: mqtt
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: mqtt_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      mysql:
        image: mysql:9
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: mqtt_test
          MYSQL_USER: mqtt
          MYSQL_PASSWORD: testpass
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Download frontend build
        uses: actions/download-artifact@v5
        with:
          name: frontend-build
          path: web/dist/

      - name: Run SQLite tests
        if: matrix.database == 'sqlite'
        run: go test -v ./internal/storage/... ./internal/provisioning/...
        env:
          DB_TYPE: sqlite

      - name: Run PostgreSQL tests
        if: matrix.database == 'postgres'
        run: go test -v ./internal/storage/... ./internal/provisioning/...
        env:
          DB_TYPE: postgres
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: mqtt
          DB_PASSWORD: testpass
          DB_NAME: mqtt_test

      - name: Run MySQL tests
        if: matrix.database == 'mysql'
        run: go test -v ./internal/storage/... ./internal/provisioning/...
        env:
          DB_TYPE: mysql
          DB_HOST: localhost
          DB_PORT: 3306
          DB_USER: mqtt
          DB_PASSWORD: testpass
          DB_NAME: mqtt_test

  # Frontend testing
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run linter
        working-directory: web
        run: npm run lint --if-present

      - name: Run tests
        working-directory: web
        run: npm test --if-present

      - name: Build frontend
        working-directory: web
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: frontend-build
          path: web/dist
          retention-days: 7

  # Build verification
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    needs: [test-go, test-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build frontend
        working-directory: web
        run: |
          npm ci
          npm run build

      - name: Build Go binary
        run: |
          mkdir -p bin
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          go build -ldflags="-X main.version=$VERSION" -v -o bin/bromq .

      - name: Verify binary
        run: |
          ./bin/bromq --help || echo "Binary created successfully"
          ls -lh bin/bromq

      - name: Upload binary
        uses: actions/upload-artifact@v5
        with:
          name: bromq-binary
          path: bin/bromq
          retention-days: 7

  # Linting
  lint:
    name: Go Lint
    runs-on: ubuntu-latest
    needs: test-frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download frontend build
        uses: actions/download-artifact@v5
        with:
          name: frontend-build
          path: web/dist/

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m --tests=false

  # Docker build test
  docker:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: bromq:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Docker dev build (push to ghcr.io on main)
  docker-dev:
    name: Docker Dev Build
    needs: [test-go, test-frontend, lint]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push dev image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:main
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test-frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Download frontend build
        uses: actions/download-artifact@v5
        with:
          name: frontend-build
          path: web/dist/

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Run gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -exclude=G404 ./...
