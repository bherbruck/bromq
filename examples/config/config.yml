# BroMQ Configuration File
#
# This file is used to provision MQTT users and ACL rules.
# The configuration is synced to the database on every startup.
# This file is the source of truth for provisioned items (like Grafana provisioning).
#
# Environment variable interpolation is supported: ${VAR_NAME} or $VAR_NAME
# Reserved placeholders are preserved: ${username} and ${clientid}
#   - ${username} is replaced at runtime with the authenticated MQTT username
#   - ${clientid} is replaced at runtime with the MQTT client ID
#
# Usage:
#   ./bromq -config config.yml
#   Or set CONFIG_FILE environment variable:
#   CONFIG_FILE=/etc/bromq/config.yml ./bromq

# MQTT Users (device credentials for MQTT connections)
# These are NOT dashboard admin users - they are for MQTT client authentication
users:
  # Basic user with environment variable password
  - username: sensor_user
    password: ${SENSOR_PASSWORD}
    description: "Temperature and humidity sensors"
    metadata:
      location: "warehouse-a"
      device_type: "environmental_sensor"

  # Admin MQTT user for management devices
  - username: admin_device
    password: ${ADMIN_DEVICE_PASSWORD}
    description: "Administrative MQTT clients"

  # Camera/video devices
  - username: camera_user
    password: ${CAMERA_PASSWORD}
    description: "Security cameras"
    metadata:
      location: "building-perimeter"
      device_type: "ip_camera"

  # Building automation controllers
  - username: automation_user
    password: ${AUTOMATION_PASSWORD}
    description: "Building automation systems"

# ACL Rules (topic access control)
# Rules reference users by username and define topic patterns with permissions
acl_rules:
  # ===== Sensor User Rules =====
  # Sensors can publish/subscribe to their own namespace using ${username} placeholder
  - username: sensor_user
    topic: "sensors/${username}/#"
    permission: pubsub

  # Sensors can publish telemetry using ${clientid} placeholder (per-device isolation)
  - username: sensor_user
    topic: "telemetry/${clientid}/data"
    permission: pub

  # Sensors can subscribe to commands for their specific device
  - username: sensor_user
    topic: "commands/${clientid}/#"
    permission: sub

  # Sensors can publish to shared data topics with wildcards
  - username: sensor_user
    topic: "data/+/temperature"
    permission: pub

  - username: sensor_user
    topic: "data/+/humidity"
    permission: pub

  # ===== Camera User Rules =====
  # Cameras can publish video streams
  - username: camera_user
    topic: "video/${clientid}/stream"
    permission: pub

  # Cameras receive control commands
  - username: camera_user
    topic: "camera/${clientid}/control"
    permission: sub

  # ===== Automation User Rules =====
  # Automation can read all sensor data
  - username: automation_user
    topic: "sensors/#"
    permission: sub

  - username: automation_user
    topic: "data/#"
    permission: sub

  # Automation can publish commands to all devices
  - username: automation_user
    topic: "commands/#"
    permission: pub

  # Automation can access building systems
  - username: automation_user
    topic: "building/hvac/#"
    permission: pubsub

  - username: automation_user
    topic: "building/lighting/#"
    permission: pubsub

  # ===== Admin Device Rules =====
  # Admin devices have full access
  - username: admin_device
    topic: "#"
    permission: pubsub

# MQTT Bridges (connect to remote MQTT brokers)
# Bridges forward messages between this broker and remote brokers
bridges:
  # Example: Forward sensor data to cloud broker
  - name: cloud-bridge
    host: ${CLOUD_MQTT_HOST}
    port: 1883
    username: ${CLOUD_MQTT_USER}
    password: ${CLOUD_MQTT_PASSWORD}
    client_id: edge-broker-001
    clean_session: true
    keep_alive: 60
    connection_timeout: 30
    metadata:
      description: "Bridge to cloud MQTT broker"
      location: "edge-to-cloud"
    topics:
      # Forward all sensor data to cloud with prefix
      - local: "sensors/#"
        remote: "edge/site-a/sensors/#"
        direction: out
        qos: 1

      # Receive commands from cloud
      - local: "commands/#"
        remote: "cloud/commands/site-a/#"
        direction: in
        qos: 1

  # Example: Connect to partner/customer broker
  - name: partner-bridge
    host: mqtt.partner-company.com
    port: 8883
    username: integration_user
    password: ${PARTNER_MQTT_PASSWORD}
    client_id: integration-bridge
    clean_session: false
    keep_alive: 120
    metadata:
      description: "Integration with partner systems"
    topics:
      # Share specific data both ways
      - local: "shared/data/#"
        remote: "shared/data/#"
        direction: both
        qos: 2

      # Receive alerts from partner
      - local: "partner/alerts/#"
        remote: "alerts/#"
        direction: in
        qos: 1

  # Example: Backup/archive broker
  - name: archive-bridge
    host: ${ARCHIVE_MQTT_HOST}
    port: 1883
    username: archive_writer
    password: ${ARCHIVE_MQTT_PASSWORD}
    topics:
      # Archive all telemetry data (one-way)
      - local: "telemetry/#"
        remote: "archive/telemetry/#"
        direction: out
        qos: 0

      # Archive video metadata
      - local: "video/+/metadata"
        remote: "archive/video/+/metadata"
        direction: out
        qos: 0

# Scripts (JavaScript automation and processing)
# Scripts execute automatically in response to MQTT events
scripts:
  # Example 1: Load script from file
  - name: message-logger
    description: "Log all published messages with metadata"
    enabled: true
    file: ./examples/scripts/message-logger.js
    triggers:
      - type: on_publish
        topic: "#"
        priority: 100
        enabled: true

  # Example 2: Temperature monitoring with alerts
  - name: temperature-alert
    description: "Monitor temperature readings and send alerts"
    enabled: true
    file: ./examples/scripts/temperature-alert.js
    metadata:
      threshold: 30
      alert_interval: 300
    triggers:
      - type: on_publish
        topic: "sensors/+/temperature"
        priority: 50
        enabled: true

  # Example 3: Connection tracking
  - name: connection-tracker
    description: "Track client connection durations"
    enabled: true
    file: ./examples/scripts/connection-tracker.js
    triggers:
      - type: on_connect
        priority: 10
        enabled: true
      - type: on_disconnect
        priority: 10
        enabled: true

  # Example 4: Rate limiting
  - name: rate-limiter
    description: "Prevent message flooding"
    enabled: true
    file: ./examples/scripts/rate-limiter.js
    metadata:
      max_per_minute: 100
    triggers:
      - type: on_publish
        topic: "#"
        priority: 5
        enabled: true

  # Example 5: Message routing and transformation
  - name: message-router
    description: "Transform and republish messages"
    enabled: true
    file: ./examples/scripts/message-router.js
    triggers:
      - type: on_publish
        topic: "#"
        priority: 75
        enabled: true

  # Example 6: Statistics aggregation
  - name: stats-aggregator
    description: "Aggregate message statistics"
    enabled: true
    file: .//examples/scripts/stats-aggregator.js
    triggers:
      - type: on_publish
        topic: "#"
        priority: 90
        enabled: true

  # Example 7: Inline script (content instead of file)
  - name: simple-alert
    description: "Simple inline script example"
    enabled: false
    content: |
      // Simple inline script
      if (msg.payload === 'ALERT') {
        log.warn('Alert received from', msg.clientId, 'on topic', msg.topic);
        mqtt.publish('alerts/generic', JSON.stringify({
          source: msg.topic,
          client: msg.clientId,
          timestamp: Date.now()
        }), 1, false);
      }
    triggers:
      - type: on_publish
        topic: "system/#"
        priority: 50
        enabled: true
